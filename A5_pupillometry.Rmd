---
title: "pupillometry"
author: "Ryan Yan"
date: "2023-03-24"
output: html_document
---
```{r}
source(here::here("load_libraries.R"))
```

```{r set up}
theme_set(theme_bw() + #set the theme 
            theme(text = element_text(family = "Helvetica",size = 12))) #set the default text size
purpleOrange_palette6 = c("purple4","purple2","plum3","khaki","gold","goldenrod4")
purpleOrange_palette2 = c("purple4","gold")
```

```{r}
anticipation_window = c(5.5, 7.5) #4~6 plus 1.5 seconds of delay

bad_participants <- c("cn221206","vx220916")
```

```{r}
data_pupil <- read_csv("/Users/rh/Desktop/VRMID-analysis/data/pupillometry_lowpass_baselineCorrected.csv")%>%
  filter(!Subject %in% c("cn221206","vx220916"))%>% #bad participants
  # filter(condition %in% c("small","large"))%>%
  group_by(Subject)%>%
  mutate(arousal_scaled = as.numeric(scale(arousal)),
         valence_scaled = as.numeric(scale(valence)))%>%
  ungroup()

data_pupil$trial_type <- factor(data_pupil$trial_type, levels = c("-$5","-$1","-$0","+$0","+$1","+$5"))

data_pupil <- data_pupil%>%
  group_by(Subject)%>%
  mutate_at(vars(pupil_L,pupil_R,pupil_Avg,pupil_L_baseline,pupil_R_baseline,pupil_Avg_baseline,pupil_L_bc,pupil_R_bc,pupil_Avg_bc), 
            list(scale = scale))

#z-scoring

# names(data_pupil)
data_pupil <- data_pupil%>%
  mutate(sample_in_trial_t = round(sample_in_trial_t,4))

data_pupil <- data_pupil%>%
  group_by(Subject, sample_in_trial_n)%>%
  mutate(arousal_scaled_change = arousal_scaled - lag(arousal_scaled,1),
         valence_scaled_change = valence_scaled - lag(valence_scaled,1))%>%
  ungroup()
```

<!-- # data without baseline correction -->
<!-- ```{r eval = FALSE} -->
<!-- setwd('..') -->
<!-- data_pupil <- read_csv(paste0(getwd(),"/data/pupillometry_lowpass.csv"))%>% -->
<!--   group_by(Subject, Time)%>% -->
<!--   mutate(sample_in_sec = row_number())%>% -->
<!--   ungroup()%>% -->
<!--   group_by(Subject,trial)%>% -->
<!--   mutate(sample_in_trial_n = row_number(), -->
<!--          sample_in_trial_t = sample_in_trial_n/120) -->

<!-- data_pupil$trial_type <- factor(data_pupil$trial_type, -->
<!--                                    levels = c("-$5","-$1","-$0", -->
<!--                                               "+$0","+$1","+$5")) -->

<!-- write_csv(data_pupil, "/Users/rh/Desktop/VRMID-analysis/data/pupillometry_lowpass_noBaselineCorrection.csv") -->

<!-- data_pupil <- read_csv("/Users/rh/Desktop/VRMID-analysis/data/pupillometry_lowpass_noBaselineCorrection.csv")%>% -->
<!--   filter(!Subject %in% c("cn221206","vx220916"))%>% #bad participants -->
<!--   group_by(Subject)%>% -->
<!--   mutate(arousal_scaled = as.numeric(scale(arousal)), -->
<!--          valence_scaled = as.numeric(scale(valence)))%>% -->
<!--   ungroup() -->

<!-- data_pupil$trial_type <- factor(data_pupil$trial_type, levels = c("-$5","-$1","-$0","+$0","+$1","+$5")) -->

<!-- data_pupil <- data_pupil%>% -->
<!--   group_by(Subject)%>% -->
<!--   mutate_at(vars(pupil_L,pupil_R,pupil_Avg),  -->
<!--             list(scale = scale)) -->

<!-- #z-scoring -->

<!-- # names(data_pupil) -->
<!-- data_pupil <- data_pupil%>% -->
<!--   mutate(sample_in_trial_t = round(sample_in_trial_t,4)) -->
<!-- ``` -->

# entire timeline
```{r}
data_pupil_summary_anticipation_nobc <- data_pupil%>%
  ungroup()%>%
  filter(probe == "anti")%>%
  group_by(trial_type,sample_in_trial_t)%>%
  summarise(mean = mean(pupil_Avg_scale, na.rm = T),
            lower = mean(pupil_Avg_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_scale, na.rm = T) / sqrt(n()))

ggplot(data_pupil_summary_anticipation_nobc%>%
         filter(sample_in_trial_t <= 20), aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = trial_type), size = 1)+
  geom_ribbon(aes(x = sample_in_trial_t,
                  ymin = lower, 
                  ymax = upper, fill = trial_type), 
              alpha = 0.2)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin =0.1, xmax = 4, ymin = -1.5, ymax = 1.5,
           color = "lightseagreen", fill = NA)+
  annotate("text", x = 2,y = 1.2, label = "anticipation",
          color = "lightseagreen")+
  annotate("rect", xmin =4.1, xmax = 6, ymin = -1.5, ymax = 1.5,
          color = "lightskyblue1", fill = NA)+
  annotate("text", x = 5,y = 1.2, label = "fixation",
          color = "lightskyblue1")+
  annotate("rect", xmin =14.1, xmax = 16, ymin = -1.5, ymax = 1.5,
           color = "lightskyblue3", fill = NA)+
  annotate("text", x = 15,y = 1.2, label = "target",
          color = "lightskyblue3")+
  annotate("rect", xmin = 16.1, xmax = 18, ymin = -1.5, ymax = 1.5,
           color = "lightskyblue4", fill = NA)+
  annotate("text", x = 17,y = 1.2, label = "outcome",
          color = "lightskyblue4")+
  # geom_vline(xintercept = 0 + 1.5, color = "lightseagreen")+
  # geom_vline(xintercept = 4 + 1.5, color = "lightskyblue1")+
  # geom_vline(xintercept = 14 + 1.5, color = "lightskyblue3")+
  # geom_vline(xintercept = 16 + 1.5, color = "lightskyblue4")+
  labs(title = "anticipation probe",
       x = "time (s)",
       y = "z-scored pupil size")
```

```{r}
data_pupil_summary_anticipation <- data_pupil%>%
  ungroup()%>%
  filter(probe == "anti")%>%
  group_by(trial_type,sample_in_trial_t)%>%
  summarise(mean = mean(pupil_Avg_bc_scale, na.rm = T),
            lower = mean(pupil_Avg_bc_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_bc_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()))

p_ant <- ggplot(data_pupil_summary_anticipation%>%
         filter(sample_in_trial_t <= 20), aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = trial_type), size = 1)+
  geom_ribbon(aes(x = sample_in_trial_t,
                  ymin = lower, 
                  ymax = upper, fill = trial_type), 
              alpha = 0.2)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin =0.1, xmax = 4, ymin = -1.5, ymax = 1.5,
           color = "lightseagreen", fill = NA)+
  annotate("text", x = 2,y = 1.2, label = "c",
          color = "lightseagreen")+
  annotate("rect", xmin =4.1, xmax = 6, ymin = -1.5, ymax = 1.5,
          color = "lightskyblue1", fill = NA)+
  annotate("text", x = 5,y = 1.2, label = "f",
          color = "lightskyblue1")+
  annotate("rect", xmin =14.1, xmax = 16, ymin = -1.5, ymax = 1.5,
           color = "lightskyblue3", fill = NA)+
  annotate("text", x = 15,y = 1.2, label = "t",
          color = "lightskyblue3")+
  annotate("rect", xmin = 16.1, xmax = 18, ymin = -1.5, ymax = 1.5,
           color = "lightskyblue4", fill = NA)+
  annotate("text", x = 17,y = 1.2, label = "o",
          color = "lightskyblue4")+
  annotate("text", x = 10,y = 1.2, label = "self-report",
          color = "black")+
  # geom_vline(xintercept = 0 + 1.5, color = "lightseagreen")+
  # geom_vline(xintercept = 4 + 1.5, color = "lightskyblue1")+
  # geom_vline(xintercept = 14 + 1.5, color = "lightskyblue3")+
  # geom_vline(xintercept = 16 + 1.5, color = "lightskyblue4")+
  labs(title = "anticipation probe",
       x = "time (s)",
       y = "z-scored pupil size")+
  theme(legend.position = "top")
```

```{r fig.width=8, fig.height=6, warning = FALSE}
data_pupil_summary_anticipation <- data_pupil%>%
  ungroup()%>%
  filter(probe == "anti")%>%
  group_by(condition,sample_in_trial_t)%>%
  summarise(mean = mean(pupil_Avg_bc_scale, na.rm = T),
            lower = mean(pupil_Avg_bc_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_bc_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()))

ggplot(data_pupil_summary_anticipation%>%
         filter(sample_in_trial_t <= 20), aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = condition), size = 1)+
  geom_ribbon(aes(x = sample_in_trial_t,
                  ymin = lower, 
                  ymax = upper, fill = condition), 
              alpha = 0.2)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin =0.1, xmax = 4, ymin = -3, ymax = 1.5,
           color = "lightseagreen", fill = NA)+
  annotate("text", x = 1,y = 1.2, label = "ant",
          color = "lightseagreen")+
  annotate("rect", xmin =4.1, xmax = 6, ymin = -3, ymax = 1.5,
          color = "lightskyblue1", fill = NA)+
  annotate("text", x = 5,y = 1.2, label = "fix",
          color = "lightskyblue1")+
  annotate("rect", xmin =14.1, xmax = 16, ymin = -3, ymax = 1.5,
           color = "lightskyblue3", fill = NA)+
  annotate("text", x = 15,y = 1.2, label = "tar",
          color = "lightskyblue3")+
  annotate("rect", xmin = 16.1, xmax = 18, ymin = -3, ymax = 1.5,
           color = "lightskyblue4", fill = NA)+
  annotate("text", x = 17,y = 1.2, label = "out",
          color = "lightskyblue4")+
  labs(title = "anticipation probe",
       x = "time (s)",
       y = "z-scored pupil size")
```


```{r warning = F, message = F}
data_pupil_summary_outcome <- data_pupil%>%
  ungroup()%>%
  filter(probe == "out")%>%
  group_by(trial_type,sample_in_trial_t)%>%
  summarise(mean = mean(pupil_Avg_bc_scale, na.rm = T),
            lower = mean(pupil_Avg_bc_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_bc_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()))

p_out <- ggplot(data_pupil_summary_outcome%>%
         filter(sample_in_trial_t <= 20), aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = trial_type), size = 1)+
  geom_ribbon(aes(x = sample_in_trial_t,
                  ymin = lower, 
                  ymax = upper, fill = trial_type), 
              alpha = 0.2)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin =0.1, xmax = 4, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightseagreen", fill = NA)+
  annotate("text", x = 2,y = 1.2, label = "c",
          color = "lightseagreen")+
  annotate("rect", xmin =4.1, xmax = 6, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightskyblue1", fill = NA)+
  annotate("text", x = 5,y = 1.2, label = "f",
          color = "lightskyblue1")+
  annotate("text", x = 15,y = 1.2, label = "self-report",
          color = "black")+
  annotate("rect", xmin = 6.1, xmax = 8, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightskyblue3", fill = NA)+
  annotate("text", x = 7,y = 1.2, label = "t",
          color = "lightskyblue3")+
  annotate("rect", xmin = 8.1, xmax = 10, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightskyblue4", fill = NA)+
  annotate("text", x = 9,y = 1.2, label = "o",
          color = "lightskyblue4")+
  labs(title = "Outcome probe",
       x = "time (s)",
       y = "z-scored pupil size")+
  theme(legend.position = "none")
```


```{r fig.width=8, fig.height=6}
p_ant / p_out
```

```{r}
data_pupil_summary_outcome_hitmiss <- data_pupil%>%
  ungroup()%>%
  filter(probe == "out")%>%
  group_by(trial_type,sample_in_trial_t,reaction_outcome)%>%
  summarise(mean = mean(pupil_Avg_bc_scale, na.rm = T),
            lower = mean(pupil_Avg_bc_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_bc_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()))

pp <- ggplot(data_pupil_summary_outcome_hitmiss%>%
         filter(sample_in_trial_t <= 20), aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = trial_type, linetype = reaction_outcome), size = 1)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin = 8.1, xmax = 10, ymin = -2, ymax = 1.5,
           alpha = .2, color = "lightskyblue4", fill = NA)+
  labs(title = "Outcome probe",
       y = "time (s)",
       x = "z-scored pupil size",
       linetype = "outcome")+
  guides(color = FALSE)+
  facet_wrap(~trial_type, nrow = 2)
```

#anticipation 

```{r}
data_pupil_summary_anti <- data_pupil%>%
  filter(sample_in_trial_t <= anticipation_window[2]+1.5)%>%
  ungroup()%>%
  group_by(trial_type,sample_in_trial_t)%>%
  summarise(mean = mean(pupil_Avg_bc_scale, na.rm = T),
            lower = mean(pupil_Avg_bc_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_bc_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()))

p1 <- ggplot(data_pupil_summary_anti, aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = trial_type), size = 1)+
  geom_ribbon(aes(x = sample_in_trial_t,
                  ymin = lower, 
                  ymax = upper, fill = trial_type), 
              alpha = 0.3)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin =0.1, xmax = 4, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightseagreen", fill = NA)+
  annotate("text", x = 2,y = 1.2, label = "cue",
          color = "lightseagreen")+
  annotate("rect", xmin =4.1, xmax = 6, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightskyblue1", fill = NA)+
  annotate("text", x = 5,y = 1.2, label = "anticipation",
          color = "lightskyblue1")+
  labs(title = "anticipation phase",
       x = "time (s)",
       y = "z-scored pupil size")+
  theme(legend.position = "none")
```

#outcome 

```{r}
data_pupil_summary_out <- data_pupil%>%
  filter(ifelse(probe == "anti", sample_in_trial_t <= 18 + 1.5 & sample_in_trial_t > 14,
                sample_in_trial_t <= 10 + 1.5 & sample_in_trial_t > 6))%>%
  mutate(sample_in_trial_t = ifelse(probe == "anti", sample_in_trial_t - 8,
                sample_in_trial_t))%>%
  ungroup()%>%
  mutate(sample_in_trial_t = round(sample_in_trial_t,4))%>%
  group_by(trial_type,sample_in_trial_t)%>%
  summarise(mean = mean(pupil_Avg_bc_scale, na.rm = T),
            lower = mean(pupil_Avg_bc_scale, na.rm = T) - qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()),
            upper = mean(pupil_Avg_bc_scale, na.rm = T) + qt(0.975, df = n() - 1) * sd(pupil_Avg_bc_scale, na.rm = T) / sqrt(n()))

p2 <- ggplot(data_pupil_summary_out, aes(x = sample_in_trial_t,
                       y = mean))+
  geom_line(aes(color = trial_type), size = 1)+
  geom_ribbon(aes(x = sample_in_trial_t,
                  ymin = lower, 
                  ymax = upper, fill = trial_type), 
              alpha = 0.3)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  annotate("rect", xmin = 6.1, xmax = 8, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightskyblue3", fill = NA)+
  annotate("text", x = 7,y = 1.2, label = "target",
          color = "lightskyblue3")+
  annotate("rect", xmin = 8.1, xmax = 10, ymin = -1.5, ymax = 1.5,
           alpha = .2, color = "lightskyblue4", fill = NA)+
  annotate("text", x = 9,y = 1.2, label = "outcome",
          color = "lightskyblue4")+
  labs(title = "outcome phase",
       x = "time (s)",
       y = "z-scored pupil size")+
  theme(legend.position = "none")
```

```{r}
p_all <- p1+p2+ 
  plot_layout(widths = c(2, 1))
p_all
```

# hypothesis testing
## confirmatory hypotheses

```{r}
modA <- lmer(mean_pupil_bc_ant ~ trial_type + (1|condition) + (1|Subject),data_lm_anti)

mydf <- ggpredict(modA, terms = c("trial_type"))

ind_pupil_ant_sub <- data_pupil%>%
  filter(sample_in_trial_t > anticipation_window[1] & sample_in_trial_t <= anticipation_window[2])%>%
  ungroup()%>%
  group_by(Subject,trial_type)%>%
  summarise(mean_pupil = mean(pupil_Avg_bc_scale, na.rm = T))

p_ant_mean <- ggplot()+
  scale_color_manual(values = purpleOrange_palette6)+
  geom_line(data = ind_pupil_ant_sub, aes(x = trial_type, y = mean_pupil, group = Subject),alpha = 0.3)+
  geom_point(data = mydf, aes(x = x, y = predicted, color = x),
             size = 2)+
  geom_errorbar(data = mydf, aes(x = x, ymin = predicted-std.error, ymax = predicted+std.error,
                                 color = x),
                width = 0.2, size = 1)+
  labs(title = "Anticipation (1.5~3.5s post fixation onset)")+
  theme(legend.position = "none")

# ggplot(ind_pupil_ant, aes(x = trial_type, y = mean_pupil,
#                           color = trial_type))+
#   geom_jitter(width = 0.2, alpha = 0.5)+
#   scale_color_manual(values = purpleOrange_palette6)+
#   stat_summary(geom = "pointrange")+
#   stat_summary(aes(group = 1),geom = "line", color = "black")+
#   labs(title = "Anticipation (1.5~3.5s post fixation onset)")+
#   theme(legend.position = "none")

modAA <- lmer(arousal_scaled ~ trial_type + (1|condition) + (1|Subject),data_lm_anti)
anova(modAA)

modAV <- lmer(valence_scaled ~ trial_type + (1|condition) + (1|Subject),data_lm_anti)
anova(modAV)
```
#A1: Yes, Greater pupil dilation during anticipation for high gain trials (+$5) compared to low gain trials (+$0)
```{r}
modA
lsmeans(modA,pairwise~trial_type)
```

# A2: Yes, Greater pupil dilation during anticipation for high gain trials (+$5) compared to low gain trials (+$0)


# B1: No
# B2: No
```{r warning = F, message = F}
data_lm_anti <-  data_pupil%>%
  mutate(pupil_window = ifelse(sample_in_trial_t <= 16 + 3.5 & sample_in_trial_t > 16 + 1.5,
                               "out",
                               ifelse(sample_in_trial_t <= anticipation_window[2] & sample_in_trial_t > anticipation_window[1],
                                      "ant",NA)))%>%
  filter(probe == "anti", pupil_window %in% c("out","ant"))%>%
  ungroup()%>%
  group_by(probe,Subject,trial,reaction_outcome,trial_type,PosA_scaled,NegA_scaled,
           arousal,valence,pupil_window,
           arousal_scaled,valence_scaled,
           arousal_scaled_change,valence_scaled_change,condition,reaction_time)%>%
  summarise(mean_pupil_bc = mean(pupil_Avg_bc_scale, na.rm = T),
            mean_pupil_nobc = mean(pupil_Avg_scale, na.rm = T),
            mean_pupil_baseline = mean(pupil_Avg_baseline_scale, na.rm = T))%>%
  pivot_wider(values_from = mean_pupil_bc:mean_pupil_baseline, names_from = pupil_window)%>%
  ungroup()%>%
  mutate(log_rt = log(reaction_time))

write_csv(data_lm_anti, "/Users/rh/Desktop/VRMID-analysis/data/data_lm_anticipation.csv")
```



```{r}
#hypothesis B1
lmeB1 <- lmer(PosA_scaled ~ mean_pupil_bc_ant + (1|Subject) + (1|condition),data_lm_anti%>%
                filter(trial_type == "+$5"))
summary(lmeB1)
plot_model(lmeB1, type = "pred", terms = c("mean_pupil_bc"),
           show.data = T)+
  labs(title = "Anticipation Pos Arous +$5 (1.5~2.5s)")

#hypothesis B2
lmeB2 <- lmer(NegA_scaled ~ mean_pupil_bc +  (1|Subject) + (1|condition),data_lm_anti%>%
                filter(trial_type == "-$5"))
summary(lmeB2)
plot_model(lmeB2, type = "pred", terms = c("mean_pupil_bc"),
           show.data = T)+
  labs(title = "Anticipation Neg Arous -$5 (1.5~2.5s)")
```

```{r}
l1ant <- lmer(arousal_scaled ~ valence_scaled + I(valence_scaled^2) + (1|Subject) + (1|condition),data_lm_anti)
summary(l1ant)
plot_model(l1ant, type = "pred", terms = "valence_scaled",
           show.data = T)
```
```{r}
l1 <- lmer(arousal_scaled_change ~ arousal_scaled + (1|Subject) + (1|condition),data_lm_anti)
summary(l1)
plot_model(l1, type = "pred", terms = "arousal_scaled",
           show.data = T)

l2 <- lmer(valence_scaled_change ~ valence_scaled + (1|Subject) + (1|condition),data_lm_anti)
summary(l2)
plot_model(l2, type = "pred", terms = "valence_scaled",
           show.data = T)
```

```{r message=FALSE, warning=FALSE}
lme7 <- lmer(PosA_scaled ~ mean_pupil_bc_ant + mean_pupil_bc_out + (1|Subject) + (1|condition),
              data_lm_anti)
summary(lme7)
p3 <- plot_model(lme7, type = "pred", terms = c("mean_pupil_bc_ant"),
           show.data = T)+
  labs(title = "Anticipation Pos Arous")+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)

summary(lmer(PosA_scaled ~ mean_pupil_bc_ant + trial_type + (1|Subject) + (1|condition),
              data_lm_anti))

lme8 <- lmer(NegA_scaled ~ mean_pupil_bc_ant + mean_pupil_bc_out + (1|Subject) + (1|condition),
              data_lm_anti)
summary(lme8)
p4 <- plot_model(lme8, type = "pred", terms = c("mean_pupil_bc_ant"),
           show.data = T)+
  labs(title = "Anticipation Neg Arous")+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)

summary(lmer(NegA_scaled ~ mean_pupil_bc_ant + trial_type + (1|Subject) + (1|condition),
              data_lm_anti))

lme9 <- lmer(arousal_scaled ~ mean_pupil_bc_ant + (1|Subject) + (1|condition),
              data_lm_anti)
summary(lme9)
lme9a <- lmer(scale(arousal_scaled) ~ scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_anti)
summary(lme9a)
r.squaredGLMM(lme9a)
EMAtools::lme.dscore(lme9a, data = data_lm_anti,
                     type = "lme4")

summary(lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_anti))
r.squaredGLMM(lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_anti))
EMAtools::lme.dscore(lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_anti),
              data = data_lm_anti,
              type = "lme4")

p4b <- plot_model(lme9, type = "pred", terms = c("mean_pupil_bc_ant"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Anticipation arousal",
       x = "phasic pupil size",
       y = "scaled arousal")+
  xlim(-4,4)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  geom_text(aes(x = 2,y = 1.2, label = "***"), color = "black")

summary(lmer(arousal_scaled ~ mean_pupil_bc_ant + trial_type + (1|Subject) + (1|condition),
              data_lm_anti))

lme10 <- lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_ant) + trial_type + (1|Subject) + (1|condition),
              data_lm_anti)
summary(lme10)
EMAtools::lme.dscore(lme10, data = data_lm_anti,"lme4")
p4c <- plot_model(lme10, type = "pred", terms = c("mean_pupil_bc_ant"),
           show.data = T,dot.size = 0.5)+
  labs(title = "Anticipation valence",
       x = "phasic pupil size",
       y = "scaled valence")+
  xlim(-4,4)+
  scale_color_manual(values = purpleOrange_palette6)+
  scale_fill_manual(values = purpleOrange_palette6)+
  geom_text(aes(x = 2,y = 0, label = "n.s."), color = "black")

p4b+p4c
```


```{r warning = F, message = F}
data_lm_anti <- data_lm_anti%>%
  mutate(trial_type_binary = ifelse(
    trial_type %in% c("+$5","+$1","+$0"),
    "+",
    "-"
  ))

```

# outcome hit and miss
```{r}
ind_pupil_out_sub <- data_pupil%>%
  filter(ifelse(probe == "anti", sample_in_trial_t <= 16 + 3.5 & sample_in_trial_t > 16 + 1.5,
                sample_in_trial_t <= 8 + 3.5 & sample_in_trial_t > 8 + 1.5))%>%
  ungroup()%>%
  group_by(Subject,trial_type,reaction_outcome)%>%
  summarise(mean_pupil = mean(pupil_Avg_bc_scale, na.rm = T))

modO <- lmer(mean_pupil_bc_out ~ trial_type * reaction_outcome + (1|Subject) + (1|condition),data_lm_outcome)
anova(modO)
summary(modO)
mydf2 <- ggpredict(modO, terms = c("trial_type","reaction_outcome"))
mydf2$x <- factor(mydf2$x, levels = c("-$5","-$1","-$0","+$0","+$1","+$5"))

p_out_mean <- ggplot()+
  scale_color_manual(values = purpleOrange_palette6)+
  geom_line(data = ind_pupil_out_sub%>%
              filter(reaction_outcome == "Hit"), aes(group = Subject,
                                         x = trial_type, 
                                         y = mean_pupil,
                                         linetype = reaction_outcome),
            alpha = 0.1)+
  geom_line(data = ind_pupil_out_sub%>%
              filter(reaction_outcome == "Miss"), aes(group = Subject,
                                         x = trial_type, 
                                         y = mean_pupil,
                                         linetype = reaction_outcome),
            alpha = 0.1)+
  geom_point(data = mydf2, aes(x = x, y = predicted,color = x,
                               shape = group),position = position_dodge(width = 0.50),
             size = 2)+
  geom_errorbar(data = mydf2, aes(x = x, ymin = predicted-std.error,
                                  ymax = predicted+std.error,color = x,
                               linetype = group),position = position_dodge(width = 0.50),
                size = 1, width = 0.2)+
  labs(title = "Outcome (1.5~3.5s after outcome onset)",
       linetype = "outcome")+
  theme(legend.position = "right")+
  guides(color = FALSE)

# ggplot(ind_pupil_out, aes(x = trial_type, y = mean_pupil_bc,
#                           color = trial_type,shape = reaction_outcome))+
#   geom_jitter(width = 0.2, alpha = 0.5)+
#   scale_color_manual(values = purpleOrange_palette6)+
#   stat_summary(aes(group = reaction_outcome,
#                    shape = reaction_outcome),geom = "pointrange")+
#   stat_summary(aes(group = reaction_outcome, linetype = reaction_outcome),geom = "line", color = "black")+
#   labs(title = "Outcome (1.5~3.5s after outcome onset)")+
#   theme(legend.position = "right")+
#   guides(color = FALSE)

modOA <- lmer(arousal_scaled ~ trial_type * reaction_outcome + (1|Subject) + (1|condition),data_lm_outcome)
anova(modOA)

modOV <- lmer(valence_scaled ~ trial_type * reaction_outcome + (1|Subject) + (1|condition),data_lm_outcome)
anova(modOV)
```
```{r}
modO
lsmeans(modO,pairwise~trial_type)
```

```{r}
summary(lmer(mean_pupil_bc ~ reaction_outcome + (1|Subject),ind_pupil_out))

```



```{r}
theme_set(theme_bw() + #set the theme 
            theme(text = element_text(family = "Helvetica",size = 8)))

(p_ant+p_ant_mean+p_out+p_out_mean)+
  plot_layout(nrow = 2, widths = c(2,1))

p_ant + p_out + p_all + pp + p_ant_mean + p_out_mean +
  plot_layout(design = c(area(1,1,2,2),
              area(1,3,2,4),
              area(3,1,4,4),
              area(5,1,6,4),
              area(7,1,8,2),
              area(7,3,8,4)))+
  plot_annotation(tag_levels = "A")
```

# hypothesis C1 C2
```{r warning = F, message = F}
data_pupil_C <- data_pupil%>%
  filter(ifelse(probe == "anti", sample_in_trial_t <= 16 + 3.5 & sample_in_trial_t > 16 + 1.5,
                sample_in_trial_t <= 8 + 3.5 & sample_in_trial_t > 8 + 1.5))%>%
  ungroup()%>%
  group_by(Subject,trial,reaction_outcome,probe,trial_type,condition)%>%
  summarise(mean_pupil_bc = mean(pupil_Avg_bc_scale, na.rm = T))

lmeC1 <- lmer(mean_pupil_bc ~ reaction_outcome + (1|Subject) + (1|condition),
              data_pupil_C%>%
                filter(trial_type == "+$5"))
summary(lmeC1)

lmeC2 <- lmer(mean_pupil_bc ~ reaction_outcome + (1|Subject) + (1|condition),
              data_pupil_C%>%
                filter(trial_type == "-$5"))
summary(lmeC2)
```

```{r}
data_lm_outcome <-  data_pupil%>%
  mutate(pupil_window = ifelse(sample_in_trial_t <= 8 + 3.5 & sample_in_trial_t > 8 + 1.5,
                               "out",
                               ifelse(sample_in_trial_t <= anticipation_window[2] & sample_in_trial_t > anticipation_window[1],
                                      "ant",NA)))%>%
  filter(probe == "out", pupil_window %in% c("out","ant"))%>%
  ungroup()%>%
  group_by(probe,Subject,trial,trial_type,PosA_scaled,NegA_scaled,
           arousal,valence,pupil_window,
           arousal_scaled,valence_scaled,arousal_scaled_change,valence_scaled_change,
           condition,reaction_outcome,reaction_time)%>%
  summarise(mean_pupil_bc = mean(pupil_Avg_bc_scale, na.rm = T),
            mean_pupil_nobc = mean(pupil_Avg_scale, na.rm = T),
            mean_pupil_baseline = mean(pupil_Avg_baseline_scale, na.rm = T))%>%
  pivot_wider(values_from = mean_pupil_bc:mean_pupil_baseline, names_from = pupil_window)%>%
  mutate(log_rt = log(reaction_time))

data_lm_outcome$trial_type<- factor(data_lm_outcome$trial_type, levels = c("-$5","-$1","-$0","+$0","+$1","+$5"))

write_csv(data_lm_outcome, "/Users/rh/Desktop/VRMID-analysis/data/data_lm_outcome.csv")
```



```{r}
lme11 <- lmer(scale(arousal_scaled) ~ scale(mean_pupil_bc_out) * reaction_outcome + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_outcome%>%
               mutate(reaction_outcome = factor(reaction_outcome, levels = c("Hit","Miss"))))
summary(lme11)
EMAtools::lme.dscore(lme11,data_lm_outcome,
                     type = "lme4")
lme11a <- lmer(scale(arousal_scaled) ~ scale(mean_pupil_bc_out) * reaction_outcome + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_outcome%>%
               mutate(reaction_outcome = factor(reaction_outcome, levels = c("Miss","Hit"))))
summary(lme11a)
EMAtools::lme.dscore(lme11a,data_lm_outcome,
                     type = "lme4")

lme11b <- lmer(scale(arousal_scaled) ~ scale(mean_pupil_bc_out) + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_outcome)
summary(lme11b)
p5 <- plot_model(lme11b, type = "pred", terms = c("mean_pupil_bc_out"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Outcome Arousal",
       x = "phasic pupil size",
       y = "scaled arousal")+
  theme(legend.position = "none")+
  geom_text(aes(x = 3,y = 1.2, label = "***"), color = "black")
EMAtools::lme.dscore(summary(lme11b), data_lm_outcome, "lme4")

lme12 <- lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_out) * reaction_outcome  + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_outcome%>%
               mutate(reaction_outcome = factor(reaction_outcome, levels = c("Hit","Miss"))))
summary(lme12)
lme12a <- lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_out) * reaction_outcome  + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_outcome%>%
               mutate(reaction_outcome = factor(reaction_outcome, levels = c("Miss","Hit"))))
summary(lme12a)
EMAtools::lme.dscore(lme12a,data_lm_outcome%>%
               mutate(reaction_outcome = factor(reaction_outcome, levels = c("Miss","Hit"))),
                     type = "lme4")

summary(lmer(scale(mean_pupil_bc_out) ~ scale(valence_scaled) * reaction_outcome + scale(arousal_scaled)* reaction_outcome + (1|Subject) + (1|condition),
              data_lm_outcome))
anova(lmer(scale(mean_pupil_bc_out) ~ scale(valence_scaled) * reaction_outcome + scale(arousal_scaled)* reaction_outcome + (1|Subject) + (1|condition),
              data_lm_outcome))

summary(lmer(scale(mean_pupil_bc_out) ~ scale(valence_scaled) + scale(arousal_scaled) + (1|Subject) + (1|condition),
              data_lm_outcome%>%filter(reaction_outcome == "Hit")))

summary(lmer(scale(mean_pupil_bc_out) ~ scale(valence_scaled) + scale(arousal_scaled) + (1|Subject) + (1|condition),
              data_lm_outcome%>%filter(reaction_outcome == "Miss")))

plot_model(lme12, type = "pred", terms = c("mean_pupil_bc_out","reaction_outcome"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Outcome valence",
       x = "phasic pupil size",
       y = "scaled valence",
       color = "outcome")+
  scale_color_bluebrown_d(reverse = F)+
  scale_fill_bluebrown_d(reverse = F)+
  geom_text(aes(x = 1,y = 1.2, label = "***"), color = "black")+
  geom_text(aes(x = 1,y = -1.5, label = "***"), color = "black")

lme12b <- lmer(scale(valence_scaled) ~ scale(mean_pupil_bc_out)  + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              data_lm_outcome)
summary(lme12b)
EMAtools::lme.dscore(summary(lme12b), data_lm_outcome, "lme4")
p6 <- plot_model(lme12b, type = "pred", terms = c("mean_pupil_bc_out"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Outcome valence",
       x = "phasic pupil size",
       y = "scaled valence",
       color = "outcome")+
  geom_text(aes(x = 2,y = 0.2, label = "n.s."), color = "black")

p5+p6
```

```{r}
lm_intA <- lmer(scale(arousal_scaled) ~ mean_pupil_bc_ant * trial_type + (1|Subject) + (1|condition), data_lm_anti)
```

#baseline stuff
```{r}
da <- data_lm_anti%>%
  filter(!is.na(mean_pupil_baseline_ant), !is.na(mean_pupil_bc_ant))
t <- lmer(arousal_scaled ~  mean_pupil_baseline_ant + (1|Subject) + (1|condition),
              da)
p <-lmer(arousal_scaled ~  mean_pupil_bc_ant + (1|Subject) + (1|condition),
              da)
tp <- lmer(arousal_scaled ~  mean_pupil_nobc_ant + (1|Subject) + (1|condition),
              da)
anova(t,p,tp)
r.squaredGLMM(t)
r.squaredGLMM(p)
r.squaredGLMM(tp)
EMAtools::lme.dscore(tp,da,"lme4")
```
```{r}
do <- data_lm_outcome%>%
  filter(!is.na(mean_pupil_baseline_out), !is.na(mean_pupil_bc_out))
t <- lmer(scale(arousal_scaled) ~  scale(mean_pupil_baseline_out) + (1|Subject) + (1|condition),
              do)
p <-lmer(arousal_scaled ~  mean_pupil_bc_out + (1|Subject) + (1|condition),
              do)
tp <- lmer(arousal_scaled ~  mean_pupil_nobc_out + (1|Subject) + (1|condition),
              do)
anova(t,p,tp)
r.squaredGLMM(t)
r.squaredGLMM(p)
r.squaredGLMM(tp)
EMAtools::lme.dscore(t,do,"lme4")
EMAtools::lme.dscore(tp,do,"lme4")
```

#tonic activity

```{r}
lme13 <- lmer(scale(arousal_scaled) ~  scale(mean_pupil_baseline_ant) + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              da)
summary(lme13)
EMAtools::lme.dscore(summary(lme13), da, "lme4")
p7a <- plot_model(lme13, type = "pred", terms = c("mean_pupil_baseline_ant"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Anticipation arousal",
       x = "tonic pupil size",
       y = "scaled arousal")+
  geom_text(aes(x = 2,y = 1.5, label = "***"), color = "black")

lme14 <- lmer(scale(valence_scaled) ~  scale(mean_pupil_baseline_ant) + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              da)
summary(lme14)
p7b <- plot_model(lme14, type = "pred", terms = c("mean_pupil_baseline_ant"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Anticipation valence",
       x = "tonic pupil size",
       y = "scaled arousal")+
  geom_text(aes(x = 2,y = 0.5, label = "n.s."), color = "black")

lme15 <- lmer(scale(arousal_scaled) ~  scale(mean_pupil_baseline_ant) +  scale(mean_pupil_bc_out) + scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition),
              do)
summary(lme15)
EMAtools::lme.dscore(lme15,do,"lme4")

p8a <- plot_model(lme15, type = "pred", terms = c("mean_pupil_baseline_ant"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Outcome arousal",
       x = "tonic pupil size",
       y = "scaled arousal")+
  geom_text(aes(x = 2,y = 1.5, label = "***"), color = "black")

lme16 <- lmer(scale(valence_scaled) ~  scale(mean_pupil_baseline_ant) + scale(mean_pupil_bc_out) + scale(mean_pupil_bc_ant)  + (1|Subject) + (1|condition),
              do)
summary(lme16)
p8b <- plot_model(lme16, type = "pred", terms = c("mean_pupil_baseline_ant"),
           show.data = T, dot.size = 0.5)+
  labs(title = "Outcome valence",
       x = "tonic pupil size",
       y = "scaled arousal")+
  geom_text(aes(x = 2,y = 0, label = "n.s."), color = "black")
```

```{r}
p4b+p4c+ p5+p6 + p7a+p7b+p8a+p8b+
  plot_layout(nrow = 2)+
  plot_annotation(tag_level = "A")
```

## fatigue: visualise tonic activity over time
```{r}
data_pupil_tonic <- unique(data_pupil%>%
  filter(Time_sec == 1)%>%
  select(Subject,probe,trial,pupil_Avg_baseline,
         arousal_scaled,valence_scaled,reaction_outcome,
         condition))%>%
  group_by(Subject)%>%
  mutate(pupil_Avg_baseline = as.numeric(scale(pupil_Avg_baseline)))%>%
  mutate(half = ifelse(trial >= 48,"second","first"))

summary(lmer(scale(pupil_Avg_baseline) ~ half + (1|Subject),data_pupil_tonic))
EMAtools::lme.dscore(lmer(scale(pupil_Avg_baseline) ~ half + (1|Subject),data_pupil_tonic),
                     data_pupil_tonic,
                     type = "lme4")

pt1 <- ggplot(data_pupil_tonic, aes(x = trial, y = pupil_Avg_baseline))+
  geom_line(aes(group = Subject), alpha = 0.1)+
  stat_summary(geom = "line")+
  labs(y = "mean tonic pupil dilation",
       title = "Experiment time course")

pt2 <- ggplot(data_pupil_tonic)+
  stat_summary(aes(group = Subject, x = half, y = pupil_Avg_baseline),geom = "line",
               size = 0.5, alpha = 0.3)+
  stat_summary( aes(x = half, y = pupil_Avg_baseline),geom = "pointrange")+
  labs(y = "mean tonic pupil dilation",
       title = "First vs. second half")

m1 <- lmer(scale(pupil_Avg_baseline) ~ half + (1|Subject),data_pupil_tonic)
summary(m1)

plot_model(m1, type = "pred", terms = "half")

pt1+pt2+
  plot_layout(width = c(2,1))

#phasic for comparison
data_lm_beh <- full_join(data_lm_anti,data_lm_outcome)
data_lm_beh <- data_lm_beh%>%
  mutate(trial_type_num = as.numeric(gsub("[^0-9.-]", "", trial_type)),
         trialgain = ifelse(trial_type_num >= 0,
                            ifelse(reaction_outcome == "Hit",
                                   trial_type_num,
                                   0),
                            ifelse(reaction_outcome == "Miss",
                                   trial_type_num,
                                   0)))

data_lm_beh <- data_lm_beh%>%
  mutate(half = ifelse(trial >= 48,"second","first"))
m2 <- lmer(scale(mean_pupil_bc_ant) ~ half + (1|Subject) + (1|probe),data_lm_beh)
summary(m2)
EMAtools::lme.dscore(m2,data_lm_beh,"lme4")

m3 <- lmer(scale(mean_pupil_bc_out) ~ half + (1|Subject) + (1|probe),data_lm_beh)
summary(m3)
EMAtools::lme.dscore(m3,data_lm_beh,"lme4")
```

## carryover: previous trials' affect and baseline pupil
```{r}
data_pupil_tonic_carryover <- data_pupil_tonic%>%
  group_by(Subject)%>%
  mutate(arousal_past0 = arousal_scaled,
        arousal_past1 = lag(arousal_scaled,1),
         arousal_past2 = lag(arousal_scaled,2),
         arousal_past3 = lag(arousal_scaled,3),
         arousal_past4 = lag(arousal_scaled,4),
         arousal_past5 = lag(arousal_scaled,5),
         arousal_past6 = lag(arousal_scaled,6),
         arousal_past7 = lag(arousal_scaled,7),
         arousal_past8 = lag(arousal_scaled,8),
         arousal_past9 = lag(arousal_scaled,9),
         arousal_past10 = lag(arousal_scaled,10),
         arousal_past11 = lag(arousal_scaled,11),
         arousal_past12 = lag(arousal_scaled,12),
         arousal_past13 = lag(arousal_scaled,13),
         arousal_past14 = lag(arousal_scaled,14),
         arousal_past15 = lag(arousal_scaled,15),
         arousal_past16 = lag(arousal_scaled,16),
         arousal_past17 = lag(arousal_scaled,17),
         arousal_past18 = lag(arousal_scaled,18),
         arousal_past19 = lag(arousal_scaled,19),
         arousal_past20 = lag(arousal_scaled,20),
         arousal_past21 = lag(arousal_scaled,21),
         arousal_past22 = lag(arousal_scaled,22),
         arousal_past23 = lag(arousal_scaled,23),
         arousal_past24 = lag(arousal_scaled,24),
         arousal_past25 = lag(arousal_scaled,25),
         arousal_past26 = lag(arousal_scaled,26),
         arousal_past27 = lag(arousal_scaled,27),
         arousal_past28 = lag(arousal_scaled,28),
         arousal_past29 = lag(arousal_scaled,29),
         arousal_past30 = lag(arousal_scaled,30),
         arousal_past31 = lag(arousal_scaled,31),
         arousal_past32 = lag(arousal_scaled,32),
         arousal_past33 = lag(arousal_scaled,33),
         arousal_past34 = lag(arousal_scaled,34),
         arousal_past35 = lag(arousal_scaled,35),
         arousal_past36 = lag(arousal_scaled,36),
         arousal_past37 = lag(arousal_scaled,37),
         arousal_past38 = lag(arousal_scaled,38),
         arousal_past39 = lag(arousal_scaled,39),
         arousal_past40 = lag(arousal_scaled,40))

df_integration <- {}
for (i in 0:40){
    my.f <- as.formula(paste0("scale(pupil_Avg_baseline) ~ scale(arousal_past",i, ") + (1|Subject) + (1|condition)"))
  dft <- as.data.frame(t(summary(lmer(my.f,data_pupil_tonic_carryover))$coefficients[2,]))
  dft$term = paste0("arousal")
  dft$past = i
  df_integration <- rbind(df_integration,dft)
  
  #   my.f <- as.formula(paste0("scale(pupil_Avg_baseline) ~ scale(valence_past",i, ") + (1|Subject)"))
  # dft <- as.data.frame(t(summary(lmer(my.f,data_pupil_tonic_carryover))$coefficients[2,]))
  # dft$term = paste0("valence")
  # dft$past = i
  # df_integration <- rbind(df_integration,dft)
}

pt3 <- ggplot(df_integration%>%
         filter(term == "arousal"), aes(x = past, y = `t value`))+
  geom_line()+
  scale_x_reverse()+
  labs(x = "Number of trials past",
       title = "Tonic pupil ~ previous arousal ratings")+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_hline(yintercept = 2.096, linetype = "dashed", color = "grey")+
  annotate("text",y = 2.4, x = 10, label = "t = 2.096")

summary(lmer(scale(pupil_Avg_baseline) ~ scale(arousal_past1) + scale(arousal_past2)+ scale(arousal_past3)+ scale(arousal_past4)+ scale(arousal_past5)+ scale(arousal_past6)+ scale(arousal_past7)+ scale(arousal_past8)+ scale(arousal_past9)+ scale(arousal_past10) + (1|Subject) + (1|condition) ,data_pupil_tonic_carryover))
```
### phasic control
```{r}
data_pupil_phasic <- unique(data_pupil%>%
  filter(Time_sec >= 5.5 & Time_sec <= 7.5)%>%
  select(Subject,probe,trial,pupil_Avg_bc_scale,
         arousal_scaled,valence_scaled,reaction_outcome,
         condition))%>%
  group_by(Subject,trial,arousal_scaled,valence_scaled,reaction_outcome,condition)%>%
  summarise(pupil_Avg_phasic = as.numeric(mean(pupil_Avg_bc_scale,na.rm = T)))%>%
  mutate(half = ifelse(trial >= 48,"second","first"))

data_pupil_phasic_carryover <- data_pupil_phasic%>%
  group_by(Subject)%>%
  mutate(arousal_past0 = arousal_scaled,
        arousal_past1 = lag(arousal_scaled,1),
         arousal_past2 = lag(arousal_scaled,2),
         arousal_past3 = lag(arousal_scaled,3),
         arousal_past4 = lag(arousal_scaled,4),
         arousal_past5 = lag(arousal_scaled,5),
         arousal_past6 = lag(arousal_scaled,6),
         arousal_past7 = lag(arousal_scaled,7),
         arousal_past8 = lag(arousal_scaled,8),
         arousal_past9 = lag(arousal_scaled,9),
         arousal_past10 = lag(arousal_scaled,10),
         arousal_past11 = lag(arousal_scaled,11),
         arousal_past12 = lag(arousal_scaled,12),
         arousal_past13 = lag(arousal_scaled,13),
         arousal_past14 = lag(arousal_scaled,14),
         arousal_past15 = lag(arousal_scaled,15),
         arousal_past16 = lag(arousal_scaled,16),
         arousal_past17 = lag(arousal_scaled,17),
         arousal_past18 = lag(arousal_scaled,18),
         arousal_past19 = lag(arousal_scaled,19),
         arousal_past20 = lag(arousal_scaled,20),
         arousal_past21 = lag(arousal_scaled,21),
         arousal_past22 = lag(arousal_scaled,22),
         arousal_past23 = lag(arousal_scaled,23),
         arousal_past24 = lag(arousal_scaled,24),
         arousal_past25 = lag(arousal_scaled,25),
         arousal_past26 = lag(arousal_scaled,26),
         arousal_past27 = lag(arousal_scaled,27),
         arousal_past28 = lag(arousal_scaled,28),
         arousal_past29 = lag(arousal_scaled,29),
         arousal_past30 = lag(arousal_scaled,30),
         arousal_past31 = lag(arousal_scaled,31),
         arousal_past32 = lag(arousal_scaled,32),
         arousal_past33 = lag(arousal_scaled,33),
         arousal_past34 = lag(arousal_scaled,34),
         arousal_past35 = lag(arousal_scaled,35),
         arousal_past36 = lag(arousal_scaled,36),
         arousal_past37 = lag(arousal_scaled,37),
         arousal_past38 = lag(arousal_scaled,38),
         arousal_past39 = lag(arousal_scaled,39),
         arousal_past40 = lag(arousal_scaled,40))

df_integration <- {}
for (i in 0:40){
  print(i)
    my.f <- as.formula(paste0("scale(pupil_Avg_phasic) ~ scale(arousal_past",i, ") + (1|Subject) + (1|condition)"))
  dft <- as.data.frame(t(summary(lmer(my.f,data_pupil_phasic_carryover))$coefficients[2,]))
  dft$term = paste0("arousal")
  dft$past = i
  df_integration <- rbind(df_integration,dft)
  
  #   my.f <- as.formula(paste0("scale(pupil_Avg_baseline) ~ scale(valence_past",i, ") + (1|Subject)"))
  # dft <- as.data.frame(t(summary(lmer(my.f,data_pupil_tonic_carryover))$coefficients[2,]))
  # dft$term = paste0("valence")
  # dft$past = i
  # df_integration <- rbind(df_integration,dft)
}

ggplot(df_integration%>%
         filter(term == "arousal"), aes(x = past, y = `t value`))+
  geom_line()+
  scale_x_reverse()+
  labs(x = "Number of trials past",
       title = "Phasic pupil ~ previous arousal ratings")+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_hline(yintercept = 2.096, linetype = "dashed", color = "grey")+
  annotate("text",y = 2.4, x = 10, label = "t = 2.096")
```


```{r}
data_lm_anti_reward_history <- data_pupil%>%
  filter(sample_in_trial_t > 5.5 & sample_in_trial_t <= 7.5)%>%
  ungroup()%>%
  group_by(probe,Subject,trial,trial_type,
           PosA_scaled,NegA_scaled,
           arousal_scaled,valence_scaled,
           condition,current_stimulus,
           reaction_outcome)%>%
  summarise(mean_pupil = mean(pupil_Avg_scale, na.rm = T),
            mean_tonic_pupil = mean(pupil_Avg_baseline, na.rm = T))%>%
  ungroup()%>%
  group_by(Subject)%>%
  mutate(hit = as.numeric(reaction_outcome == "Hit"))%>%
  mutate(recent_avg_winpercent1 = lag(rollmean(hit, 1, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent2 = lag(rollmean(hit, 2, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent3 = lag(rollmean(hit, 3, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent4 = lag(rollmean(hit, 4, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent5 = lag(rollmean(hit, 5, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent6 = lag(rollmean(hit, 6, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent7 = lag(rollmean(hit, 7, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent8 = lag(rollmean(hit, 8, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent9 = lag(rollmean(hit, 9, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent10 = lag(rollmean(hit, 10, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent11 = lag(rollmean(hit, 11, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent12 = lag(rollmean(hit, 12, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent13 = lag(rollmean(hit, 13, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent14 = lag(rollmean(hit, 14, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent15 = lag(rollmean(hit, 15, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent16 = lag(rollmean(hit, 16, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent17 = lag(rollmean(hit, 17, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent18 = lag(rollmean(hit, 18, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent19 = lag(rollmean(hit, 19, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent20 = lag(rollmean(hit, 20, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent21 = lag(rollmean(hit, 21, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent22 = lag(rollmean(hit, 22, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent23 = lag(rollmean(hit, 23, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent24 = lag(rollmean(hit, 24, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent25 = lag(rollmean(hit, 25, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent26 = lag(rollmean(hit, 26, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent27 = lag(rollmean(hit, 27, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent28 = lag(rollmean(hit, 28, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent29 = lag(rollmean(hit, 29, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent30 = lag(rollmean(hit, 30, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent31 = lag(rollmean(hit, 31, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent32 = lag(rollmean(hit, 32, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent33 = lag(rollmean(hit, 33, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent34 = lag(rollmean(hit, 34, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent35 = lag(rollmean(hit, 35, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent36 = lag(rollmean(hit, 36, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent37 = lag(rollmean(hit, 37, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent38 = lag(rollmean(hit, 38, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent39 = lag(rollmean(hit, 39, na.pad = TRUE, align = "right"),1),
         recent_avg_winpercent40 = lag(rollmean(hit, 40, na.pad = TRUE, align = "right"),1))
  # mutate_at(vars(recent_avg_winpercent1:recent_avg_winpercent33),
  #           ~scale(.x))

data_lm_anti_reward_history$hit <- as.factor(data_lm_anti_reward_history$hit)

ggplot(data_lm_anti_reward_history%>%filter(Subject == "ah230203"), aes(x = trial))+
  stat_summary(aes(y = recent_avg_winpercent1), color = "grey", geom = "line",size=2)+
  stat_summary(aes(y = recent_avg_winpercent30), color = "gold", geom = "line",size=2)+
  stat_summary(aes(y = recent_avg_winpercent17), color = "orange", geom = "line",size=2)+
  stat_summary(aes(y = recent_avg_winpercent10), color = "red", geom = "line",size=2)+
  stat_summary(aes(y = recent_avg_winpercent5), color = "red3", geom = "line",size=2)+
  stat_summary(aes(y = recent_avg_winpercent3), color = "brown4", geom = "line",size=2)
```


```{r warning=FALSE, message = FALSE}
lmer_out_tonic <- {}
for (i in 1:40) {
  my.formula <- as.formula(paste0("scale(mean_tonic_pupil) ~ scale(recent_avg_winpercent",i, ") +(1|Subject) + (1|condition)"))
  lm_temp <- lmer(my.formula,data_lm_anti_reward_history)
  lmer_out_tonic <- rbind(lmer_out_tonic, summary(lm_temp)$coefficients[2,])
}

lmer_out_tonic <- as.data.frame(lmer_out_tonic)
lmer_out_tonic$coef <- names(data_lm_anti_reward_history)[15:(14+nrow(lmer_out_tonic))]
lmer_out2 <- lmer_out_tonic%>%
  relocate(coef)%>%
  rowwise()%>%
  mutate(coef = strsplit(coef,"percent")[[1]][2])

lmer_out2$coef <- factor(lmer_out2$coef, levels = c(1:40))
lmer_out2$p_val <- (lmer_out2$`Pr(>|t|)` < 0.001)

pt4 <- ggplot(lmer_out2%>%
                filter(as.numeric(coef) <= 20), aes(x = as.numeric(coef), y = `t value`))+
  geom_line(aes(group = 1), color = "black")+
  # geom_point(aes(shape = p_val, color = p_val))+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_hline(yintercept = -2.096, linetype = "dashed",color = "grey")+
  annotate("text",x = 17, y = -1.9, label = "t = -2.096")+
  labs(title = "Tonic pupil ~ recent task difficulty",
       x = "X-trials-average task difficulty")

l1 <- lmer(scale(mean_tonic_pupil) ~ scale(recent_avg_winpercent4) + (1 | 
    Subject) + (1 | condition), data_lm_anti_reward_history)
summary(l1)
plot_model(l1, type = "pred", terms = c("recent_avg_winpercent4"))
```

```{r}
pt1+pt2+pt3+pt4+
  plot_layout(widths = c(2,1))+
  plot_annotation(tag_levels = "A")
```
# parametric modulation
```{r}
l_pm <- lmer(scale(trialgain) ~ scale(mean_pupil_bc_ant) + (1|Subject) + (1|condition) + (1|probe),data_lm_beh)
summary(l_pm)
EMAtools::lme.dscore(l_pm, data_lm_beh, type = "lme4")
pm1 <- plot_model(l_pm, type = "pred",
           terms = c("mean_pupil_bc_ant"),
           show.data = T, dot.size = 0.5)+
  labs(x = "phasic anticipatory pupil",
       y = "$ this trial",
       title = "money earned ~ phasic anticipatory pupil")+
  annotate("text",x = 3, y = 2,label = "***")

l_pm2 <- lmer(scale(trialgain) ~ scale(mean_pupil_baseline_ant) + (1|Subject) + (1|condition) + (1|probe),data_lm_beh)
summary(l_pm2)
EMAtools::lme.dscore(l_pm2,data_lm_beh,
                     type = "lme4")
pm2 <- plot_model(l_pm2, type = "pred",
           terms = c("mean_pupil_baseline_ant"),
           show.data = T, dot.size = 0.5)+
  labs(x = "tonic pupil",
       y = "$ this trial",
       title = "money earned ~ tonic pupil")+
  annotate("text", x = 2,y = 2.5, label = "*")
```

```{r}
l1 <- lmer(log_rt ~ mean_pupil_bc_ant + (1|trial_type) + (1|probe) + (1|Subject) + (1|condition),data_lm_beh)
summary(l1)

l2 <- lmer(scale(log_rt) ~ scale(mean_pupil_bc_ant) + (1|Subject) + (1|probe)+ (1|condition),data_lm_beh)
summary(l2)
EMAtools::lme.dscore(l2, data_lm_beh, type = "lme4")
pm3 <- plot_model(l2,type = "pred",
           terms = "mean_pupil_bc_ant",
           show.data = T,
           dot.size = 0.5)+
  labs(x = "phasic anticipatory pupil",
       y = "log RT",
       title = "RT ~ phasic anticipatory pupil")+
  annotate("text", x = 4,y = -2, label = "***")

l3 <- lmer(scale(log_rt) ~ scale(mean_pupil_baseline_ant) + (1|Subject) + (1|probe)+ (1|condition),data_lm_beh)
summary(l3)
EMAtools::lme.dscore(l3,data_lm_beh,
                     type = "lme4")
pm4 <- plot_model(l3,type = "pred",
           terms = "mean_pupil_baseline_ant",
           show.data = T,
           dot.size = 0.5)+
  labs(x = "tonic pupil",
       y = "log RT",
       title = "RT ~ tonic pupil")+
  annotate("text", x = 3,y = -2, label = "n.s.")
```
## mediation

```{r}
fit.mediator= lme4::lmer(arousal_scaled ~ mean_pupil_bc_ant + (1|Subject),data_lm_anti)
fit.dv1= lme4::lmer(trialgain ~ arousal_scaled + mean_pupil_bc_ant+ (1|Subject),data_lm_anti)
result1 = mediation::mediate(fit.mediator, fit.dv1, 
                             treat='mean_pupil_bc_ant', 
                             mediator='arousal_scaled')
summary(result1)
plot(result1)

#reversed
fit.mediatorb= lme4::lmer(mean_pupil_bc_ant ~ arousal_scaled + (1|Subject),data_lm_anti)
result1b = mediation::mediate(fit.mediatorb, fit.dv1, 
                             treat='arousal_scaled', 
                             mediator='mean_pupil_bc_ant')
summary(result1b)
plot(result1b)
```

```{r}
pm1+pm3+pm2+pm4+
  plot_layout(nrow = 2)+
  plot_annotation(tag_levels = "A")
```

```{r}
fit.mediator2= lme4::lmer(arousal_scaled ~ mean_pupil_bc_ant + (1|Subject),data_lm_anti%>%filter(!is.na(log_rt)))
fit.dv2= lme4::lmer(log_rt ~ arousal_scaled + mean_pupil_bc_ant+ (1|Subject),data_lm_anti%>%filter(!is.na(log_rt)))
result2 = mediation::mediate(fit.mediator2, fit.dv2, 
                             treat='mean_pupil_bc_ant', 
                             mediator='arousal_scaled')
summary(result2)

fit.mediator2b= lme4::lmer(mean_pupil_bc_ant ~ arousal_scaled + (1|Subject),data_lm_anti%>%filter(!is.na(log_rt)))
result2b = mediation::mediate(fit.mediator2b, fit.dv2, 
                             treat='arousal_scaled', 
                             mediator='mean_pupil_bc_ant')
summary(result2b)
```
